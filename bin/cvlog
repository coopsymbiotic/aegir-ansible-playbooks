#!/bin/bash
#
# Retrieve the most recent civicrm log file from the current site and views it
#
# This file is part of aegir-ansible-playbooks

# Resolve configuration
VIEWER="${CVLOG_VIEWER:-tail -n 30 -F}"
MATCH="${CVLOG_MATCH:-CiviCRM.*.log*}"
LOGPATH="$PWD"
ROOT="/var/aegir/platforms"

# Resolve arguments
OP=${1#-}
# OP=${OP:-1}
SITENAME=${2#@}
PLATFORM=""
SCRIPTNAME=`basename "$0"`

LOGPATH=`realpath "${LOGPATH}"`

print_success() {
  GREEN=$(tput setaf 2)
  RESET=$(tput sgr0)
  CHECKMARK='\u2714'
  printf " ${GREEN}${CHECKMARK}${RESET} $1\n"
}
print_info() {
  GREEN=$(tput setaf 2)
  RESET=$(tput sgr0)
  INFO='\u2139'
  printf " ${GREEN}${INFO}${RESET} $1\n"
}
print_error() {
  RED=$(tput setaf 1)
  RESET=$(tput sgr0)
  CROSS='\u2717'
  printf " ${RED}${CROSS}${RESET} $1\n"
}

if [[ $LOGPATH =~ /platforms/([^/]*) ]]; then
  PLATFORM=${BASH_REMATCH[1]}
else
  print_error "Could not detect the platform from the current path: $LOGPATH"
  exit 1
fi

if [ -z ${SITENAME} ]; then
  if [[ $LOGPATH =~ /sites/([^/]*) ]]; then
    SITENAME=${BASH_REMATCH[1]}
  else
    print_error "Could not detect the site name from current path: $LOGPATH"
    exit 1
  fi
fi

# Resolve location of log files
LOGPATH=""

if [ -d "$ROOT/$PLATFORM/private/$SITENAME/log" ]; then
  # CiviCRM Standalone
  LOGPATH="$ROOT/$PLATFORM/private/$SITENAME/log"
elif [ -d "$ROOT/$PLATFORM/sites/$SITENAME/wp-content/uploads/civicrm/ConfigAndLog" ]; then
  # Wordpress site
  LOGPATH="$ROOT/$PLATFORM/site/$SITENAME/wp-content/uploads/civicrm/ConfigAndLog"
elif [ -d "$ROOT/$PLATFORM/web/sites/$SITENAME/private/files/ConfigAndLog" ]; then
  # Drupal10+
  LOGPATH="$ROOT/$PLATFORM/web/sites/$SITENAME/private/files/ConfigAndLog"
elif [ -d "$ROOT/$PLATFORM/sites/$SITENAME/private/files/civicrm/ConfigAndLog" ]; then
  # Drupal7
  LOGPATH="$ROOT/$PLATFORM/sites/$SITENAME/private/files/civicrm/ConfigAndLog"
elif [ -d "$ROOT/$PLATFORM/web/sites/$SITENAME/files/ConfigAndLog" ]; then
  # Legacy D10+
  LOGPATH="$ROOT/$PLATFORM/web/sites/$SITENAME/files/civicrm/ConfigAndLog"
elif [ -d "$ROOT/$PLATFORM/sites/$SITENAME/files/civicrm/ConfigAndLog" ]; then
  # Legacy D7
  LOGPATH="$ROOT/$PLATFORM/sites/$SITENAME/files/civicrm/ConfigAndLog"
fi

if [ -z "$LOGPATH" ]; then
  print_error "Failed to find a ConfigAndLog folder somewhere under $ROOT/$PLATFORM for site $SITENAME"
  exit 1
fi

cd "$LOGPATH"

# Resolve command
case $OP in
  help)
    echo "usage: $SCRIPTNAME [COMMAND] [SITE NAME]"
    echo
    echo "View the most recent CiviCRM log file located under the ConfigAndLog folder."
    echo
    echo "COMMAND"
    echo "  ls     List all log files present in the ConfigAndLog folder"
    echo "  cd     Go to the ConfigAndLog folder (opens a new bash shell)"
    echo "  pwd    Display the location of the ConfigAndLog folder"
    echo "  help   Show this message"
    echo
    echo "Environment variables"
    printf "  %-30s  %s\n" "CVLOG_VIEWER=\"$VIEWER\"" '# Log file viewer'
    printf "  %-30s  %s\n" "CVLOG_MATCH=\"$MATCH\""  '# Match pattern for CiviCRM log files'
    ;;
  pwd)
    pwd
    ;;
  cd)
    echo "Opening a new bash shell to the log folder..."
    exec bash
    ;;
  ls)
    # List available log files
    echo "Listing files matching $MATCH in $LOGPATH"
    \ls -lshpt --time-style="+%Y-%m-%d %H:%m:%S" $MATCH \
      | awk 'NR > 0 {printf "%3s) %s %s - %s %s (%s)\n", NR,$7,$8,$9,$10,$6}' \
      | tac
    ;;
  view | v)
    VIEWER="view"
    # continue to the next condition
    ;;&
  edit | e)
    VIEWER="vim"
    # continue to the next condition
    ;;&
  * )
    # Find the most recent log
    LOGFILE=$( ls -pt1 $MATCH | head -1 )
    if [ -z "$LOGFILE" ]; then
      print_error "No matches found in $LOGPATH."
      exit 1
    fi
    if [ -f "$LOGFILE" ]; then
      print_success "Opening $SITENAME log file '$LOGPATH/$LOGFILE'"
      if [[ "$VIEWER" == *"tail"* ]]; then
        print_info "Type Ctrl+C to exit. To open in vim/view, type: cvlog view"
      fi
      $VIEWER "$LOGFILE"
    else
      print_error "Expected to find a CiviCRM log file named '$LOGFILE' under '$LOGPATH'"
      exit 1
    fi
    ;;
esac
