# {{ ansible_managed }}
server {
  include       fastcgi_params;
  # Block https://httpoxy.org/ attacks.
  fastcgi_param HTTP_PROXY "";
  fastcgi_param MAIN_SITE_NAME demcloud.symbiotic.coop;
  set $main_site_name "{{ inventory_hostname }}";
  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
  listen        *:80;
  listen        [::]:80;
  server_name   {{ inventory_hostname }};
  root          {{ site_root }};
  # Allow access to letsencrypt.org ACME challenges directory.
  location ^~ /.well-known/acme-challenge {
    alias /var/aegir/config/letsencrypt.d/well-known/acme-challenge;
    try_files $uri 404;
  }
{% if cert.stat.exists %}
  location / {
    return 301 https://{{ inventory_hostname }}$request_uri;
  }
{% else %}
  include /var/aegir/config/includes/nginx_vhost_common.conf;
{% endif %}
}
{% if cert.stat.exists %}
server {
  include       fastcgi_params;

  # Block https://httpoxy.org/ attacks.
  fastcgi_param HTTP_PROXY "";

  fastcgi_param MAIN_SITE_NAME {{ inventory_hostname }};
  set $main_site_name "{{ inventory_hostname }}";
  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
  fastcgi_param HTTPS on;
  listen        *:443 ssl http2;
  listen        [::]:443 ssl http2;
  server_name   {{ inventory_hostname }};
  root          {{ site_root }};

  ssl_certificate_key        /var/aegir/config/letsencrypt.d/{{Â inventory_hostname }}/privkey.pem;
  ssl_certificate            /var/aegir/config/letsencrypt.d/{{ inventory_hostname }}/fullchain.pem;
  ssl_protocols              TLSv1.2 TLSv1.3;
  ssl_ciphers                ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:DHE-RSA-AES256-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES256-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES128-SHA:!aNULL:!eNULL:!LOW:!3DES:!DES:!MD5:!EXP:!PSK:!SRP:!DSS;
  ssl_ecdh_curve             secp384r1;
  ssl_prefer_server_ciphers  on;

  # Generate using:
  # openssl dhparam -check -5 4096 > /etc/nginx/params.4096
  # (can be re-generated regularly in a cron job)
{% if dhparams.stat.exists %}
  ssl_dhparam /etc/nginx/params.4096;
{% endif %}

  ssl_session_cache shared:SSL:10m;
  ssl_session_timeout 10m;
  keepalive_timeout 70;

  # Allow access to letsencrypt.org ACME challenges directory.
  location ^~ /.well-known/acme-challenge {
    alias /var/aegir/config/letsencrypt.d/well-known/acme-challenge;
    try_files $uri 404;
  }

{% if software == "WordPress" %}
  fastcgi_param wp_content_dir {{ site_path }}/wp-content;
  fastcgi_param wp_content_url https://{{ inventory_hostname }}/sites/{{ inventory_hostname }}/wp-content;
  fastcgi_param CIVICRM_SETTINGS {{ site_path }}/wp-content/uploads/civicrm/civicrm.settings.php;
  ###
  ### Allow some known php files.
  ###
  location ~ /wp-admin/$ {
    tcp_nopush   off;
    keepalive_requests 0;
    access_log /var/log/nginx/access.log main;
    if ($is_bot) {
      return 403;
    }
    try_files    /wp-admin/index.php =404;
    # FIXME @todo
    fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
  }
  location ~ /wp-admin/(.*).php$ {
    tcp_nopush   off;
    keepalive_requests 0;
    access_log /var/log/nginx/access.log main;
    if ($is_bot) {
      return 403;
    }
    try_files    $uri =404;
    # FIXME @todo
    fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
  }
  location ~ /wp-(.*).php$ {
    tcp_nopush   off;
    keepalive_requests 0;
    access_log /var/log/nginx/access.log main;
    if ($is_bot) {
      return 403;
    }
    try_files    $uri =404;
    # FIXME @todo
    fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
  }
  location ~ ^/wp-content/(.*)$ {
    try_files /sites/$main_site_name/wp-content/$1 =404;
  }
  # Deprecated endpoint, use civicrm/ajax/rest
  location ~ ^/sites/{{ inventory_hostname }}/wp-content/plugins/civicrm/civicrm/extern/(.*).php$ {
    tcp_nopush   off;
    keepalive_requests 0;
    access_log /var/log/nginx/access.log main;
    if ($is_bot) {
      return 403;
    }
    try_files    $uri =404;
    fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
  }
  location ~* ^/sites/.*/wp-content/uploads/civicrm/(?:ConfigAndLog|custom|upload|templates_c) {
    access_log off;
    return 404;
  }
{% endif %}

{% if site_status == 1 %}
  include /var/aegir/config/includes/nginx_vhost_common.conf;
{% else %}
  add_header Content-Type text/html;
    return 200 '<div><ul>
      <li>(en) This web site has been disabled. Please contact the server administrators for more information.</li>
      <li>(es) Este sitio web ha sido deshabilitado. Por favor contacte con los administradores para obtener m&agrave;s informaci&ograve;n.</li>
      <li>(fr) Ce site a &eacute;t&eacute; d&eacute;sactiv&eacute;. Veuillez contacter les personnes responsables de l&#39;administration du serveur pour plus d&#39;information.</li>
      </ul></div>';
{% endif %}
}
{% endif %}
